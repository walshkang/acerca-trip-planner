{
  "project_name": "AI_Travel_Itinerary_Manager",
  "version": "2.2.0-phase2-defined",
  "last_updated": "2026-01-29",
  "development_principles": [
    "LLMs label and translate intent; deterministic systems retrieve and compute.",
    "Only approved pins are truth (Map is the interface).",
    "Enrich Once, Read Forever (Frozen by default, versioned if refreshed).",
    "Strict Taxonomy: AI outputs must match UI Icon sets exactly.",
    "User edits never overwrite frozen AI enrichment."
  ],
  "pr_history": [
    {
      "id": "1b437c3",
      "date": "2026-01-27",
      "title": "Add lists link to map",
      "summary": "Added a lightweight Lists link under the Omnibox so list management is discoverable without adding global navigation."
    },
    {
      "id": "31f433d",
      "date": "2026-01-27",
      "title": "Regenerate Supabase types",
      "summary": "Regenerated Supabase types after the promote_place_candidate RPC signature added optional list assignment."
    },
    {
      "id": "e4c4f71",
      "date": "2026-01-27",
      "title": "Discovery omnibox UX loop + curated Wikipedia/Wikidata enrichment",
      "summary": "Implemented the map-first UX loop (Search → Preview → Approve): added a floating Omnibox, Ghost Pin state, and an Inspector preview card that shows frozen enrichment before approval. Added deterministic curated Wikipedia/Wikidata extraction (summary, thumbnail, stable fact pairs) stored on enrichments.curated_data, updated ingest to return preview enrichment immediately, and added minimal Supabase types + a db:types generation helper."
    },
    {
      "id": "e1d391c",
      "date": "2026-01-27",
      "title": "End-to-end auth + ingestion + detail view (plus promotion/map fixes)",
      "summary": "Added Supabase magic-link auth + gating, implemented deterministic ingestion (Google Places + optional Wikipedia/Wikidata) into place_candidates, added strict normalization (LLM temp=0 optional with deterministic fallback), built place detail view with user notes/tags, and fixed promotion RPC + map pin parsing for end-to-end flow."
    },
    {
      "id": "04aca2e",
      "date": "2026-01-27",
      "title": "Implement places_view + viewport persistence",
      "summary": "Added places_view migration with computed lat/lng, updated MapContainer to read from the view, regenerated types, and implemented fitBounds/load persistence + approval flyTo behavior."
    },
    {
      "id": "816f4b8",
      "date": "2026-01-26",
      "title": "Add JSON validation script and refresh roadmap progress",
      "summary": "Added a JSON validation script in package.json and updated roadmap progress notes."
    },
    {
      "id": "a692544",
      "date": "2026-01-26",
      "title": "Update roadmap status and progress",
      "summary": "Refined roadmap statuses, progress summaries, and last_updated date."
    },
    {
      "id": "b8dde4d",
      "date": "2026-01-26",
      "title": "Refactor promotion logic and canonicalization",
      "summary": "Moved promotion to a Postgres RPC and improved canonicalization for consistent JSON handling."
    },
    {
      "id": "9de8adc",
      "date": "2026-01-25",
      "title": "Initiated project",
      "summary": "Project scaffold and initial structure."
    },
    {
      "id": "4f42699",
      "date": "2026-01-25",
      "title": "Initiated README",
      "summary": "Added initial README content."
    },
    {
      "id": "ef8b1ce",
      "date": "2026-01-25",
      "title": "Initial commit",
      "summary": "Created repository with baseline files."
    }
  ],
  "roadmap": {
    "phase_1": {
      "name": "The Smart Repository (Cupcake)",
      "goal": "A deterministic, map-based database of approved places. Eliminates messy lists and taxonomy drift.",
      "estimated_timeline": "MVP (Weeks 1-4)",
      "status": "completed",
      "progress_summary": "Phase 1 MVP loop complete: auth-gated map, Omnibox ingestion (URL/place_id/name → place_candidates), Enriched Preview on Ghost Pins, and one-click Approve to canonical places. Enrichment is frozen at ingestion; promotion is a state transition only. Completed: places_view + map serialization and viewport persistence with fitBounds/last-view fallback, approval flyTo, lightweight search results + preview ingest, Inspector gated on preview state, lists schema + types, list CRUD UI, list assignment on approval, list-scoped tags + filters, and list membership editing from place detail + map drawer. Phase 2 is now underway.",
      "epics": [
        {
          "id": "P1-E1",
          "title": "Strict Schema, Versioning & Deduplication",
          "description": "Enforce data integrity and enrichment immutability before the first pin is dropped.",
          "tech_stack": ["Supabase", "PostgreSQL", "PostGIS"],
          "tasks": [
            {
              "id": "1.1",
              "task": "Create strict Enums and versioned enrichment schema.",
              "details": "Category Enum: ['Food', 'Coffee', 'Sights', 'Shop', 'Activity']. Energy Enum: ['Low', 'Medium', 'High']. Add fields: enrichment_version, enriched_at, enrichment_source_hash. Add curated_data JSONB for deterministic, non-LLM enrichment fields.",
              "status": "completed"
            },
            {
              "id": "1.2",
              "task": "Implement Deduplication Guard.",
              "details": "Constraint: UNIQUE(user_id, google_place_id). Re-adding a place opens edit view; enrichment is not re-run.",
              "status": "completed",
              "notes": "Implemented dual deduplication: UNIQUE(user_id, source, source_id) + UNIQUE(user_id, dedupe_key). Transactional promotion RPC (promote_place_candidate) handles conflicts race-safely with ON CONFLICT. geohash7 and dedupe_key computed in DB to match table columns exactly."
            },
            {
              "id": "1.3",
              "task": "Persist Deterministic Source Data.",
              "details": "Store raw opening_hours JSON from Google Places and source metadata for future deterministic filtering.",
              "status": "completed",
              "notes": "place_candidates.raw_payload stores complete Google Places API response. places.opening_hours stores extracted opening_hours JSON."
            },
            {
              "id": "1.4",
              "task": "Generate Supabase DB Types.",
              "details": "Generate TypeScript types from the live Postgres schema (including views like places_view) to avoid hand-maintained table/enum drift.",
              "status": "completed",
              "notes": "Added a minimal fallback Database type and wired enums to derive from it. Added `npm run db:types` to generate from SUPABASE_DB_URL (or `supabase gen types --local` when a local Supabase stack is running). Types regenerated after lists schema was added."
            }
          ]
        },
        {
          "id": "P1-E2",
          "title": "The Librarian Agent (Deterministic Ingestion)",
          "description": "Multi-source enrichment that is frozen, auditable, and schema-aligned.",
          "tech_stack": ["Edge Functions", "Google Places API", "Wikipedia API", "Wikidata API"],
          "tasks": [
            {
              "id": "2.1",
              "task": "Resolve Place Deterministically.",
              "details": "Resolve via Google Places. Fetch nearby Wikipedia pages via GeoSearch. Select best match by distance + name similarity.",
              "status": "completed",
              "notes": "Implemented Google Places Details + FindPlaceFromText, Wikipedia GeoSearch, and deterministic match selection. Added /api/places/ingest endpoint to create place_candidates from Google Maps URL, place_id, or name."
            },
            {
              "id": "2.2",
              "task": "Fetch Structured Context.",
              "details": "Pull summary, thumbnail, and structured facts via Wikidata when available. Store raw extracts.",
              "status": "completed",
              "notes": "Implemented deterministic curated extraction for UI: Wikipedia summary + thumbnail (w/api.php extracts|pageimages), Wikipedia title selection via GeoSearch, Wikidata QID resolution (pageprops.wikibase_item), and a minimal stable fact-pair mapping (Founded P571, Architect P84, Elevation P2044, Website P856). Stored frozen curated output on enrichments.curated_data and returned it immediately from /api/places/ingest for preview."
            },
            {
              "id": "2.3",
              "task": "Schema-Constrained AI Normalization.",
              "details": "LLM normalizes fetched data into enums and tags only. Prompt includes full enum list. Output must validate or be rejected.",
              "status": "completed",
              "notes": "Normalization implemented with strict runtime validation + temperature=0 when OPENAI_API_KEY is configured, and a deterministic fallback mapping when not. Invalid outputs are rejected; model + prompt_version are stored for auditability."
            },
            {
              "id": "2.4",
              "task": "Freeze Enrichment.",
              "details": "Write enrichment once, mark as frozen. No AI calls during browsing, filtering, or planning.",
              "status": "completed",
              "notes": "enrichments table with UNIQUE(source_hash, schema_version) enforces idempotency. place_candidates.enrichment_id links to frozen enrichments. Promotion RPC never triggers re-enrichment. Fixed: canonicalizeSnapshot() now properly recursive (preserves all nested keys). Fixed: Promotion moved to Postgres RPC for true transactional safety."
            }
          ]
        },
        {
          "id": "P1-E3",
          "title": "Aligned Visual Interface",
          "description": "UI that mirrors database truth exactly.",
          "tech_stack": ["Mapbox GL JS", "React"],
          "tasks": [
            {
              "id": "3.1",
              "task": "Create Canonical Icon Mapping.",
              "details": "Map strict DB categories to SVG assets. Any unmapped enum is a build-time error.",
              "status": "completed",
              "notes": "Icon mapping with build-time exhaustiveness check. SVG icons created for all categories. Test scaffolding validates enum coverage."
            },
            {
              "id": "3.2",
              "task": "Build Place Detail View.",
              "details": "Display frozen AI tags and factual summaries. Allow user-added notes and user tags stored separately.",
              "status": "completed",
              "notes": "Added /places/[id] route showing frozen enrichment + editable user_notes/user_tags (stored on places). Wired marker click → detail view, and added PATCH API for user meta updates."
            }
          ]
        },
        {
          "id": "P1-E4",
          "title": "The Airlock (Visual Ingestion)",
          "description": "A visual staging layer for items you already found. Enrichment happens at ingestion and is frozen on Ghosts; approval only promotes to canonical truth.",
          "tech_stack": ["Zustand", "Mapbox GL JS", "React"],
          "tasks": [
            {
              "id": "4.1",
              "task": "Discovery State Store",
              "details": "Zustand store for managing `ghosts` (candidates) and `selectedGhostId`.",
              "status": "completed",
              "notes": "Ghosts are staged candidates with frozen enrichment from ingestion; selection drives Inspector preview."
            },
            {
              "id": "4.2",
              "task": "The Omnibox",
              "details": "Floating input accepting URL/text. Calls /ingest. Updates store (does not auto-promote). Exact-match should open canonical place detail instead of dropping a hidden ghost under a real pin.",
              "status": "completed",
              "notes": "Ingest returns candidate + frozen enrichment for immediate preview."
            },
            {
              "id": "4.3",
              "task": "Ghost Pin Rendering",
              "details": "Map layer for 'ghosts' (grey/hollow pins). Z-index > Map, < Real Pins.",
              "status": "completed",
              "notes": "Ghost pins are intentionally visually distinct from canonical pins."
            },
            {
              "id": "4.4",
              "task": "Inspector Card & Approve",
              "details": "Preview card for Ghost Pins showing frozen enrichment. 'Approve Pin' triggers promotion RPC.",
              "status": "completed",
              "notes": "Promotion is a state transition only; no enrichment or AI calls are triggered."
            }
          ]
        },
        {
          "id": "P1-E5",
          "title": "Map View + Discovery Refinements (Phase 0-4 Plan)",
          "description": "Harden map data integrity, viewport behavior, search/preview flow, and list persistence before planner work begins.",
          "tech_stack": ["Supabase", "PostGIS", "Mapbox GL JS", "React", "Next.js"],
          "tasks": [
            {
              "id": "5.1",
              "task": "Add places_view to fix location serialization at the source.",
              "details": "Create a migration for public.places_view selecting id, user_id, name, category, created_at, and computed lat/lng via ST_Y/ST_X. Set security_invoker=true so RLS applies.",
              "status": "completed"
            },
            {
              "id": "5.2",
              "task": "Update MapContainer to read from places_view.",
              "details": "Query places_view and map lat/lng directly (remove JSON parsing of geometry).",
              "status": "completed"
            },
            {
              "id": "5.3",
              "task": "Regenerate Supabase types with places_view included.",
              "details": "Run db:types generation so the view appears in types (see Task 1.4).",
              "status": "completed"
            },
            {
              "id": "5.4",
              "task": "Fit bounds on load when places exist.",
              "details": "If places.length > 0, compute bounds to include all pins and fit map view on load.",
              "status": "completed"
            },
            {
              "id": "5.5",
              "task": "Persist and restore viewport when there are zero places.",
              "details": "Use last saved view from localStorage; otherwise fall back to a neutral global default.",
              "status": "completed"
            },
            {
              "id": "5.6",
              "task": "Fly to approved places or refit bounds after approval.",
              "details": "After approval, flyTo the new place or refit bounds depending on context.",
              "status": "completed"
            },
            {
              "id": "5.7",
              "task": "Add /api/places/search for lightweight results.",
              "details": "Return top-X candidates with minimal fields for quick listing.",
              "status": "completed"
            },
            {
              "id": "5.8",
              "task": "Expand discovery store for search + preview.",
              "details": "Add results[], selectedResultId, previewCandidate, and previewEnrichment to the store.",
              "status": "completed"
            },
            {
              "id": "5.9",
              "task": "Wire Omnibox results to preview ingest.",
              "details": "Render results list in the Omnibox; selecting a result triggers /api/places/ingest for preview.",
              "status": "completed"
            },
            {
              "id": "5.10",
              "task": "Gate InspectorCard on preview state.",
              "details": "Only render the InspectorCard when a preview candidate/enrichment exists.",
              "status": "completed"
            },
            {
              "id": "5.11",
              "task": "Rename Add to Plan to Approve Pin until lists exist.",
              "details": "Update UI copy so approval remains explicit prior to list support.",
              "status": "completed"
            },
            {
              "id": "5.12",
              "task": "Add lists + list_items schema and RLS.",
              "details": "Create list tables, relationships, and RLS policies for multi-tenant list persistence.",
              "status": "completed"
            },
            {
              "id": "5.13",
              "task": "Add list UI for create/delete/assign.",
              "details": "Build list management UI and allow assigning places to lists.",
              "status": "completed"
            },
            {
              "id": "5.14",
              "task": "Assign lists on approval and show membership.",
              "details": "Update approval flow to assign to a list and show list membership in the place detail view.",
              "status": "completed"
            }
          ]
        }
      ]
    },
    "phase_2": {
      "name": "The Interactive Planner (Birthday Cake)",
      "goal": "Stateful itinerary planning using deterministic logic only.",
      "epics": [
        {
          "id": "P2-E1",
          "title": "Stateful Planning (Kanban)",
          "features": [
            "Trip State Machine: Backlog -> Scheduled -> Done.",
            "Backlog vs Scheduled is derived from scheduled_date (NULL = Backlog) and used as the single source of truth across Map + Kanban.",
            "Drag-and-Drop between day buckets updates scheduling fields only.",
            "Scheduling actions never trigger enrichment or AI calls.",
            "Optimistic scheduling reconciles conflicts on refresh; server remains source of truth.",
            "Lightweight scheduling audit fields (last_scheduled_at, last_scheduled_by/source).",
            "Visual distinction for scheduled vs unscheduled pins."
          ]
        },
        {
          "id": "P2-E2",
          "title": "Deterministic Filtering & Intent Translation",
          "features": [
            "Intent Extraction Agent outputs filter JSON only (never SQL).",
            "Example: 'Quiet places' -> { \"energy\": \"Low\" }.",
            "Filtering executed entirely via DB queries.",
            "Filter JSON supports compound AND/OR rules from day one.",
            "Open Now filtering uses server time converted to place timezone.",
            "Cheap timezone strategy: derive IANA timezone from lat/lng offline at ingest; fallback to trip timezone or stored utc_offset_minutes."
          ]
        },
        {
          "id": "P2-E3",
          "title": "List Workspace + Tags",
          "features": [
            "List detail view: click a list to open a scrollable list of saved places.",
            "List-scoped tags per place, editable inline in the list view.",
            "Tag filters scoped to a list; define multi-select semantics (AND/OR) explicitly.",
            "List membership uses add/remove semantics (multi-list ready), not move semantics.",
            "List detail view supports local search of canonical places with add-to-list actions.",
            "Add-time tags can be provided and are unioned with seeded enrichment tags (stored on list_items.tags).",
            "User tags are stored separately from frozen enrichment (no mutation of AI data).",
            "Tag chips use a single editable set with per-chip remove + clear-all semantics; clearing persists an empty tag set.",
            "Local search uses a deterministic contract with nullable display_address.",
            "Local search accepts keyword input only and returns empty results for short queries.",
            "List search results render in a portal to avoid drawer clipping."
          ]
        },
        {
          "id": "P2-E4",
          "title": "Map-First List Context",
          "features": [
            "Lists render in a drawer/overlay so the map remains the primary interface.",
            "Selecting a list highlights/filters existing pins without refetching all places.",
            "Create list inline from the map drawer (reuse /api/lists).",
            "Search results are location-biased to the current map view (Find Place locationbias).",
            "Default map view prefers lastActiveListId or lastAddedPlaceId over global fitBounds.",
            "Place detail opens in a drawer driven by URL state to preserve deep links.",
            "Omnibox results stay above drawers via a predictable overlay layer (portal if needed).",
            "Creating or switching to an empty list must not change the map camera.",
            "Map shell includes a non-blocking sign-out affordance."
          ]
        }
      ]
    },
    "phase_3": {
      "name": "The Intelligent Concierge (Wedding Cake)",
      "goal": "Optimization and discovery without compromising trust.",
      "epics": [
        {
          "id": "P3-E1",
          "title": "Deterministic Routing",
          "features": [
            "Route Optimization via OSRM or Google Routes API.",
            "Travel-time badges rendered between scheduled items.",
            "LLMs are not involved in routing or timing."
          ]
        },
        {
          "id": "P3-E2",
          "title": "AI Discovery (Suggestion Layer)",
          "features": [
            "Discovery uses deterministic search + filters first.",
            "Optional AI summarization of discovered items (no sourcing).",
            "Results are ingested through the Airlock pipeline and appear as Ghost Pins.",
            "Approval promotes to canonical truth; no re-enrichment on approval.",
            "Rejected items are discarded and never stored."
          ]
        }
      ]
    }
  }
}
